"'Approve Screen' As screen":
    Fill: =RGBA(224,224,224,1)
    OnVisible: |-
        =Refresh('ASDocument.DocumentRequest');Refresh('ASDocument.ProcessApproval');
        //Lấy danh sách phê duyệt
        ClearCollect(gblColApprovalByRequest,AddColumns(Filter('ASDocument.DocumentRequest',status = 1 And active = 1) As Temp,"approvalUserID",LookUp('ASDocument.ProcessApproval',sort = Temp.lastSignNum And approveProcess = Temp.currentApproveLevel And documentID = Temp.documentID).userID))
        
        //ClearCollect(gblcolRequestOnProcess,Filter('ASDocument.DocumentRequest' As Temp,Temp.lastSignNum exactin (Filter('ASDocument.ProcessApproval',documentID = Temp.documentID)).sort And Temp.status = 1 And Temp.active = 1));
        //ClearCollect(gblColApprovalByRequest,AddColumns(gblcolRequestOnProcess As Temp,"approvalUserID",LookUp('ASDocument.ProcessApproval',sort = Temp.lastSignNum And documentID = Temp.documentID).userID))

    btn_as_BackGroundScreen As button:
        BorderStyle: =BorderStyle.None
        DisabledFill: =RGBA(241, 244, 250, 1)
        DisplayMode: =DisplayMode.Disabled
        Height: =767
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Text: =""
        Width: =1366
        ZIndex: =1

    ctn_Navigate_1 As groupContainer.verticalAutoLayoutContainer:
        BorderStyle: =BorderStyle.None
        DropShadow: =DropShadow.None
        Fill: =RGBA(255, 255, 255, 1)
        Height: =768
        LayoutAlignItems: =LayoutAlignItems.Stretch
        LayoutDirection: =LayoutDirection.Vertical
        LayoutMode: =LayoutMode.Auto
        RadiusBottomLeft: =20
        RadiusBottomRight: =0
        RadiusTopLeft: =20
        RadiusTopRight: =0
        Width: =196
        ZIndex: =2

        Container10_1 As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            FillPortions: =0
            Height: =100
            LayoutMinHeight: =100
            LayoutMinWidth: =1
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =20
            PaddingRight: =20
            ZIndex: =1

            img_hs_Logo_1 As image:
                AlignInContainer: =AlignInContainer.Stretch
                Height: =110
                Image: =Name
                Width: =50
                X: =11
                Y: =13
                ZIndex: =1

            Label1_1 As label:
                AlignInContainer: =AlignInContainer.Center
                Color: =RGBA(73, 113, 215, 1)
                FontWeight: =FontWeight.Bold
                Size: =15
                Text: ="Quy trình"
                Width: =145
                ZIndex: =2

        ctn_hs_NavigationMenu_1 As groupContainer.verticalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Fill: =RGBA(255, 255, 255, 1)
            LayoutDirection: =LayoutDirection.Vertical
            LayoutMinHeight: =100
            LayoutMinWidth: =0
            LayoutMode: =LayoutMode.Auto
            PaddingBottom: =70
            RadiusBottomLeft: =0
            RadiusBottomRight: =0
            RadiusTopLeft: =0
            RadiusTopRight: =0
            ZIndex: =3

            gal_hs_NavigationMenu_1 As gallery.galleryVertical:
                DelayItemLoading: =true
                Fill: =RGBA(255, 255, 255, 1)
                Height: =652
                Items: |-
                    =If(gblRecUser.roleID = 1,Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home User Screen'}),gblRecUser.roleID = 2 Or gblRecUser.roleID = 4,Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home User Screen'},{ID:2,Image:'Admin Settings Male',Title:"Phê duyệt",Navigate:'Approve Screen'}),gblRecUser.roleID = 3,Table({ID:1,Image:Home,Title:"Trang chủ",Navigate:'Home Manager Screen'},{ID:2,Image:'Admin Settings Male',Title:"Phê duyệt",Navigate:'Approve Screen'},{ID:3,Image:'Data Recovery',Title:"Thiết lập",Navigate:'User Screen'}),gblRecUser.roleID = 5,Table({ID:1,Image:'Data Recovery',Title:"Thiết lập",Navigate:'User Screen'}))
                Layout: =Layout.Vertical
                LayoutMinHeight: =287
                LayoutMinWidth: =0
                LoadingSpinner: =LoadingSpinner.Data
                OnSelect: =Navigate(ThisItem.Navigate)
                ShowScrollbar: =false
                TemplateSize: =50
                Width: =155
                X: =251
                Y: =115
                ZIndex: =1

                img_hs_MenuImage_1 As image:
                    Height: =30
                    Image: =ThisItem.Image
                    OnSelect: =Select(Parent)
                    Width: =40
                    X: =15
                    Y: =10
                    ZIndex: =1

                lbl_hs_MenuTitle_1 As label:
                    Color: =RGBA(149, 149, 149, 1)
                    FontWeight: =FontWeight.Semibold
                    Height: =29
                    OnSelect: =Select(Parent)
                    Text: =ThisItem.Title
                    Width: =117
                    X: =60
                    Y: =10
                    ZIndex: =2

                Button8_1 As button:
                    BorderThickness: =0
                    Fill: =If(ThisItem.ID = gblMenuFunctionSelected,RGBA(149, 149, 149,0.2),RGBA(0, 0, 0, 0))
                    Height: =50
                    HoverFill: =ColorFade(RGBA(149, 149, 149,0.4), -20%)
                    OnSelect: |-
                        =Select(Parent);
                        Set(gblMenuFunctionSelected,ThisItem.ID)
                    PressedFill: =RGBA(149, 149, 149,0.5)
                    RadiusBottomLeft: =0
                    RadiusBottomRight: =0
                    RadiusTopLeft: =0
                    RadiusTopRight: =0
                    Text: =""
                    Width: =195
                    X: =-5
                    ZIndex: =3

            btn_Exit_1 As button:
                AlignInContainer: =AlignInContainer.Center
                BorderColor: =RGBA(73, 113, 215, 1)
                Color: =RGBA(116, 116, 116, 1)
                Fill: =RGBA(255, 255, 255, 1)
                HoverFill: =ColorFade(RGBA(73, 113, 215, 1), -20%)
                OnSelect: =Exit()
                PressedColor: =Color.White
                PressedFill: =RGBA(73, 113, 215, 1)
                Text: ="Thoát"
                X: =18
                Y: =682
                ZIndex: =2

    ctn_as_Title As groupContainer.verticalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =41
        LayoutMode: =LayoutMode.Auto
        PaddingLeft: =30
        PaddingRight: =35
        Width: =1170
        X: =196
        Y: =104
        ZIndex: =3

        lbl_as_Title As label:
            Color: =RGBA(43, 54, 74, 1)
            FontWeight: =FontWeight.Bold
            Height: =41
            Size: =18
            Text: ="Danh sách yêu cầu"
            Width: =730
            X: =191
            Y: =101
            ZIndex: =1

        lbl_rs_DivisionTitle_7 As label:
            Align: =Align.Right
            Color: =RGBA(94, 94, 94, 1)
            FillPortions: =1
            FontWeight: =FontWeight.Semibold
            Size: =15
            Text: ="Có " & CountRows(Filter(gblColApprovalByRequest,approvalUserID = gblRecUser.userID)) & " yêu cầu đang chờ phê duyệt"
            Width: =230
            ZIndex: =2

    ctn_as_MainContent As groupContainer.horizontalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =612
        LayoutAlignItems: =LayoutAlignItems.Stretch
        LayoutGap: =10
        LayoutMode: =LayoutMode.Auto
        PaddingLeft: =40
        PaddingRight: =40
        Width: =1170
        X: =196
        Y: =155
        ZIndex: =5

        ctn_as_List As groupContainer.verticalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            LayoutAlignItems: =LayoutAlignItems.Stretch
            LayoutDirection: =LayoutDirection.Vertical
            LayoutMinHeight: =0
            LayoutMinWidth: =0
            LayoutMode: =LayoutMode.Auto
            ZIndex: =4

            ctn_as_DetailList As groupContainer.verticalAutoLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                DropShadow: =DropShadow.None
                Fill: =RGBA(255, 255, 255, 1)
                LayoutAlignItems: =LayoutAlignItems.Stretch
                LayoutDirection: =LayoutDirection.Vertical
                LayoutMinHeight: =100
                LayoutMinWidth: =250
                LayoutMode: =LayoutMode.Auto
                PaddingBottom: =10
                PaddingLeft: =10
                PaddingRight: =10
                PaddingTop: =10
                RadiusTopLeft: =20
                RadiusTopRight: =20
                ZIndex: =3

                ctn_as_ListContent As groupContainer.horizontalAutoLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DropShadow: =DropShadow.None
                    Fill: =RGBA(220, 228, 252, 1)
                    FillPortions: =0
                    Height: =40
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    LayoutMode: =LayoutMode.Auto
                    PaddingLeft: =20
                    PaddingRight: =20
                    RadiusBottomLeft: =10
                    RadiusBottomRight: =10
                    RadiusTopLeft: =10
                    RadiusTopRight: =10
                    ZIndex: =1

                    lbl_as_Reason As label:
                        Color: =RGBA(47, 47, 47, 1)
                        FillPortions: =1
                        FontWeight: =FontWeight.Bold
                        Text: ="Tên văn bản"
                        ZIndex: =1

                    lbl_as_Time As label:
                        Color: =RGBA(47, 47, 47, 1)
                        FillPortions: =1
                        FontWeight: =FontWeight.Bold
                        Text: ="Thời gian tạo"
                        ZIndex: =2

                    lbl_as_CreatedBy As label:
                        Color: =RGBA(47, 47, 47, 1)
                        FillPortions: =1
                        FontWeight: =FontWeight.Bold
                        Text: ="Người soạn thảo"
                        ZIndex: =3

                    lbl_as_CreatedBy_1 As label:
                        Color: =RGBA(47, 47, 47, 1)
                        FillPortions: =1
                        FontWeight: =FontWeight.Bold
                        Text: ="Tiến độ"
                        ZIndex: =5

                    blank_1 As label:
                        Color: =RGBA(47, 47, 47, 1)
                        FillPortions: =0.2
                        FontWeight: =FontWeight.Bold
                        LayoutMinWidth: =0
                        Text: =""
                        ZIndex: =6

                    blank_2 As label:
                        Color: =RGBA(47, 47, 47, 1)
                        FillPortions: =0.2
                        FontWeight: =FontWeight.Bold
                        LayoutMinWidth: =0
                        Text: =""
                        ZIndex: =7

                    blank_3 As label:
                        Color: =RGBA(47, 47, 47, 1)
                        FillPortions: =0.2
                        FontWeight: =FontWeight.Bold
                        LayoutMinWidth: =0
                        Text: =""
                        ZIndex: =8

                gal_as_List As gallery.galleryVertical:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    DelayItemLoading: =true
                    Items: =Sort(Filter(gblColApprovalByRequest,approvalUserID = gblRecUser.userID),ID,SortOrder.Descending)
                    Layout: =Layout.Vertical
                    LayoutMinHeight: =287
                    LayoutMinWidth: =0
                    LoadingSpinner: =LoadingSpinner.Data
                    TemplateSize: =60
                    ZIndex: =2

                    ctn_as_ItemList As groupContainer.horizontalAutoLayoutContainer:
                        BorderColor: =RGBA(73, 113, 215, 1)
                        BorderThickness: =1
                        DropShadow: =DropShadow.None
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =50
                        LayoutAlignItems: =LayoutAlignItems.Stretch
                        LayoutMode: =LayoutMode.Auto
                        PaddingLeft: =15
                        PaddingRight: =20
                        RadiusBottomLeft: =15
                        RadiusBottomRight: =15
                        RadiusTopLeft: =15
                        RadiusTopRight: =15
                        Width: =Parent.Width - 10
                        Y: =8
                        ZIndex: =1

                        lbl_as_ItemReason As label:
                            Color: =RGBA(114, 114, 114, 1)
                            FillPortions: =1
                            FontWeight: =FontWeight.Semibold
                            LayoutMinWidth: =140
                            OnSelect: |-
                                =Navigate('Request Detail Screen',ScreenTransition.Fade,{locInfoRequest:ThisItem});
                            Text: =ThisItem.documentName
                            Tooltip: =ThisItem.documentName
                            Wrap: =false
                            ZIndex: =1

                        lbl_as_ItemTime As label:
                            Color: =RGBA(114, 114, 114, 1)
                            FillPortions: =1
                            FontWeight: =FontWeight.Semibold
                            OnSelect: |-
                                =Navigate('Request Detail Screen',ScreenTransition.Fade,{locInfoRequest:ThisItem});
                            Text: =ThisItem.Created
                            Wrap: =false
                            ZIndex: =2

                        lbl_as_ItemCreatedBy As label:
                            Color: =RGBA(114, 114, 114, 1)
                            FillPortions: =1
                            FontWeight: =FontWeight.Semibold
                            OnSelect: |-
                                =Navigate('Request Detail Screen',ScreenTransition.Fade,{locInfoRequest:ThisItem});
                            Text: =LookUp(gblColAllUser,userID = ThisItem.userID).fullName
                            Wrap: =false
                            ZIndex: =3

                        Container27_21 As groupContainer.horizontalAutoLayoutContainer:
                            DropShadow: =DropShadow.None
                            LayoutAlignItems: =LayoutAlignItems.Center
                            LayoutMinHeight: =30
                            LayoutMinWidth: =150
                            LayoutMode: =LayoutMode.Auto
                            PaddingLeft: =10
                            PaddingRight: =10
                            RadiusBottomLeft: =0
                            RadiusBottomRight: =0
                            RadiusTopLeft: =0
                            RadiusTopRight: =0
                            ZIndex: =5

                            "Gallery11_8 As gallery.'BrowseLayout_Horizontal_TwoTextOneImageVariant_ver5.0'":
                                AlignInContainer: =AlignInContainer.SetByContainer
                                DelayItemLoading: =true
                                Height: |
                                    =30
                                Items: =AddColumns(Sequence(ThisItem.maxApproveLevel,1),"documentID",ThisItem.documentID,"approveProccess",ThisItem.currentApproveLevel,"requestTimeNum",ThisItem.requestTimeNum)
                                LayoutMinHeight: =0
                                LayoutMinWidth: =0
                                ShowScrollbar: =false
                                TemplatePadding: =0
                                TemplateSize: =Gallery11_8.Width/3
                                ZIndex: =1

                                Rectangle15_8 As rectangle:
                                    BorderColor: =RGBA(255, 255, 255, 1)
                                    BorderThickness: =1
                                    Fill: =If(ThisItem.approveProccess > ThisItem.Value,Color.LightGreen,Last(Filter('ASDocument.HistoryApprove',documentID = ThisItem.documentID And requestTimeNum = ThisItem.requestTimeNum + 1 And approveProcess = ThisItem.Value)).status = 2,Color.Red,RGBA(204, 231, 246, 1))
                                    Height: =Parent.TemplateHeight
                                    OnSelect: =Select(Parent)
                                    Width: =Parent.TemplateWidth
                                    ZIndex: =1

                        img_as_Reject As image:
                            FillPortions: =0.2
                            Image: =Cancel
                            ImagePosition: =ImagePosition.Center
                            LayoutMinHeight: =0
                            LayoutMinWidth: =0
                            OnSelect: |-
                                =UpdateContext({locReject:true})
                            Width: =50
                            ZIndex: =6

                        img_as_Approve As image:
                            FillPortions: =0.2
                            Image: =Ok
                            ImagePosition: =ImagePosition.Center
                            LayoutMinHeight: =0
                            LayoutMinWidth: =0
                            OnSelect: |-
                                =//Lấy danh sách phê duyệt
                                Refresh('ASDocument.DocumentRequest');Refresh('ASDocument.ProcessApproval');
                                //Lấy danh sách phê duyệt
                                ClearCollect(gblColApprovalByRequest,AddColumns(Filter('ASDocument.DocumentRequest',status = 1 And active = 1) As Temp,"approvalUserID",LookUp('ASDocument.ProcessApproval',sort = Temp.lastSignNum And approveProcess = Temp.currentApproveLevel And documentID = Temp.documentID).userID));
                                
                                UpdateContext({locApprove:true});
                                UpdateContext({locInfoRequest:ThisItem})
                            Width: =50
                            ZIndex: =7

                        img_as_Approve_1 As image:
                            AlignInContainer: =AlignInContainer.Center
                            FillPortions: =0.2
                            Height: =30
                            Image: =Transaction
                            LayoutMinHeight: =0
                            LayoutMinWidth: =0
                            OnSelect: |-
                                =UpdateContext({locTransfer:true})
                            Width: =50
                            ZIndex: =8

    ctn_as_Header As groupContainer.horizontalAutoLayoutContainer:
        DropShadow: =DropShadow.None
        Height: =104
        LayoutMode: =LayoutMode.Auto
        Width: =1170
        X: =196
        ZIndex: =6

        ctn_as_Tab As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Height: =101
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutGap: =5
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =35
            Width: =1229
            X: =137
            ZIndex: =1

            btn_as_Overview As button:
                BorderStyle: =BorderStyle.None
                Fill: =RGBA(73, 113, 215, 1)
                Height: =28
                HoverFill: =ColorFade(Self.Fill, -20%)
                PressedColor: =Color.White
                PressedFill: =Self.Fill
                RadiusBottomLeft: =5
                RadiusBottomRight: =5
                RadiusTopLeft: =5
                RadiusTopRight: =5
                Size: =13
                Text: ="Phê duyệt"
                Width: =104
                X: =191
                Y: =36
                ZIndex: =1

            btn_as_Create As button:
                BorderStyle: =BorderStyle.None
                Color: =RGBA(94, 94, 94, 1)
                DisabledFill: =RGBA(73, 113, 215, 1)
                Fill: =RGBA(255, 255, 255, 1)
                Height: =28
                HoverFill: =ColorFade(RGBA(73, 113, 215, 1), -20%)
                OnSelect: =Navigate('History Approve Screen')
                PressedFill: =RGBA(73, 113, 215, 1)
                RadiusBottomLeft: =5
                RadiusBottomRight: =5
                RadiusTopLeft: =5
                RadiusTopRight: =5
                Size: =13
                Text: ="Lịch sử"
                Width: =104
                X: =117
                Y: =36
                ZIndex: =2

        ctn_as_Info As groupContainer.horizontalAutoLayoutContainer:
            AlignInContainer: =AlignInContainer.SetByContainer
            DropShadow: =DropShadow.None
            Fill: =RGBA(220, 228, 252, 1)
            FillPortions: =0.3
            Height: =80
            LayoutMinHeight: =100
            LayoutMinWidth: =50
            LayoutMode: =LayoutMode.Auto
            PaddingLeft: =10
            PaddingRight: =10
            RadiusBottomLeft: =20
            RadiusBottomRight: =0
            RadiusTopLeft: =0
            RadiusTopRight: =20
            ZIndex: =2

            img_as_Avatar As image:
                AlignInContainer: =AlignInContainer.Center
                Height: =50
                Image: =User().Image
                LayoutMinHeight: =50
                RadiusBottomLeft: =img_as_Avatar.Height
                RadiusBottomRight: =img_as_Avatar.Height
                RadiusTopLeft: =img_as_Avatar.Height
                RadiusTopRight: =img_as_Avatar.Height
                Width: =50
                ZIndex: =1

            ctn_as_Info2 As groupContainer.verticalAutoLayoutContainer:
                AlignInContainer: =AlignInContainer.SetByContainer
                DropShadow: =DropShadow.None
                LayoutDirection: =LayoutDirection.Vertical
                LayoutMinHeight: =0
                LayoutMinWidth: =0
                LayoutMode: =LayoutMode.Auto
                PaddingLeft: =5
                ZIndex: =2

                lbl_as_Name As label:
                    FontWeight: =FontWeight.Bold
                    PaddingTop: =20
                    Size: =12
                    Text: =User().FullName
                    Wrap: =false
                    ZIndex: =1

                lbl_as_Mail As label:
                    PaddingBottom: =20
                    Size: =12
                    Text: =User().Email
                    Wrap: =false
                    ZIndex: =2

    ctn_as_Reject As groupContainer.manualLayoutContainer:
        Fill: =RGBA(0, 0, 0, 0.5)
        Height: =768
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Visible: =locReject
        Width: =1366
        ZIndex: =7

        btn_as_BackGround_7 As button:
            BorderStyle: =BorderStyle.None
            DisabledFill: =RGBA(255, 255, 255, 1)
            DisplayMode: =DisplayMode.Disabled
            Height: =269
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: =""
            Width: =608
            X: =375
            Y: =261
            ZIndex: =1

        lbl_as_Title_9 As label:
            FontWeight: =FontWeight.Bold
            Text: ="Từ chối yêu cầu"
            X: =387
            Y: =267
            ZIndex: =2

        shp_as_Deco_14 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =311
            ZIndex: =3

        ico_as_Cancel_7 As icon.Cancel:
            Color: =RGBA(149, 149, 149, 1)
            Height: =29
            Icon: =Icon.Cancel
            OnSelect: |-
                =UpdateContext({locReject:false})
            Width: =25
            X: =942
            Y: =271
            ZIndex: =4

        shp_as_Deco_15 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =473
            ZIndex: =6

        btn_as_Submit As button:
            BorderThickness: =1
            Fill: =RGBA(0, 89, 204, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =//Cập nhật lịch sử từ chối
                Patch('ASDocument.HistoryApprove',Defaults('ASDocument.HistoryApprove'),{documentID:locInfoRequest.documentID,userID:gblRecUser.userID,status:2,approveTime:Value(Day(Today()) & Month(Today()) & Year(Today())),comment:txt_as_RejectReason.Text,approveProcess:locInfoRequest.currentApproveLevel,requestTimeNum:locInfoRequest.requestTimeNum + 1},Form1.Updates);
                
                //Cập nhật trạng thái yêu cầu thành từ chối và số lần bị từ chối của yêu cầu
                Patch('ASDocument.DocumentRequest',LookUp('ASDocument.DocumentRequest',ID = locInfoRequest.ID),{requestTimeNum:locInfoRequest.requestTimeNum + 1,status:3});
                
                //Gửi mail
                'ASDocument.SendMail'.Run(LookUp(gblColAllUser,userID = locInfoRequest.userID).email,"Yêu cầu ký duyệt văn bản " & locInfoRequest.documentID & " đã bị từ chối","Tên yêu cầu: " & locInfoRequest.documentName & "<br>" & "Thời gian tạo yêu cầu: " & locInfoRequest.Created);
                
                //Cập nhật danh sách duyệt
                ClearCollect(gblcolRequestOnProcess,Filter('ASDocument.DocumentRequest' As Temp,Temp.lastSignNum exactin (Filter('ASDocument.ProcessApproval',documentID = Temp.documentID)).sort And Temp.status = 1 And Temp.active = 1));
                ClearCollect(gblColApprovalByRequest,AddColumns(gblcolRequestOnProcess As Temp,"approvalUserID",LookUp('ASDocument.ProcessApproval',sort = Temp.lastSignNum And documentID = Temp.documentID).userID));
                
                //Lấy danh sách phê duyệt
                Refresh('ASDocument.DocumentRequest');Refresh('ASDocument.ProcessApproval');
                //Lấy danh sách phê duyệt
                ClearCollect(gblColApprovalByRequest,AddColumns(Filter('ASDocument.DocumentRequest',status = 1 And active = 1) As Temp,"approvalUserID",LookUp('ASDocument.ProcessApproval',sort = Temp.lastSignNum And approveProcess = Temp.currentApproveLevel And documentID = Temp.documentID).userID));
                
                //Từ chối
                Reset(txt_as_RejectReason);
                Notify("Từ chối thành công",NotificationType.Success,1500);
                UpdateContext({locReject:false})
            PressedColor: =RGBA(255,255,255,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Xác nhận"
            Width: =118
            X: =847
            Y: =485
            ZIndex: =7

        btn_as_Cancel As button:
            BorderThickness: =1
            Color: =RGBA(0, 0, 0, 1)
            Fill: =RGBA(255, 255, 255, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =UpdateContext({locReject:false})
            PressedColor: =RGBA(0,0,0,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Hủy"
            Width: =87
            X: =746
            Y: =485
            ZIndex: =8

        lbl_as_RejectReason As label:
            Height: =28
            Text: ="Lí do"
            Width: =62
            X: =390
            Y: =327
            ZIndex: =9

        txt_as_RejectReason As text:
            BorderColor: =RGBA(116, 116, 116, 1)
            BorderThickness: =1
            Default: =""
            Height: =125
            HintText: ="Nhập lí do"
            Mode: =TextMode.MultiLine
            Width: =498
            X: =452
            Y: =327
            ZIndex: =10

    ctn_as_Approve As groupContainer.manualLayoutContainer:
        Fill: =RGBA(0, 0, 0, 0.5)
        Height: =768
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Visible: =locApprove
        Width: =1366
        ZIndex: =8

        btn_us_BackGround_8 As button:
            BorderStyle: =BorderStyle.None
            DisabledFill: =RGBA(255, 255, 255, 1)
            DisplayMode: =DisplayMode.Disabled
            Height: =575
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: =""
            Width: =608
            X: =375
            Y: =100
            ZIndex: =1

        lbl_us_Title_10 As label:
            FontWeight: =FontWeight.Bold
            Text: ="Xác nhận"
            X: =387
            Y: =105
            ZIndex: =2

        shp_us_Deco_16 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =150
            ZIndex: =3

        ico_us_Cancel_8 As icon.Cancel:
            Color: =RGBA(149, 149, 149, 1)
            Height: =29
            Icon: =Icon.Cancel
            OnSelect: |-
                =UpdateContext({locApprove:false})
            Width: =25
            X: =942
            Y: =110
            ZIndex: =4

        shp_us_Deco_17 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =627
            ZIndex: =6

        btn_us_Submit_8 As button:
            BorderThickness: =1
            Fill: =RGBA(0, 89, 204, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =//Cập nhật lịch sử phê duyệt
                Patch(
                    'ASDocument.HistoryApprove',
                    Defaults('ASDocument.HistoryApprove'),
                    {
                        documentID: locInfoRequest.documentID,
                        userID: gblRecUser.userID,
                        status: 1,
                        approveTime: Value(Day(Today()) & Month(Today()) & Year(Today())),
                        comment: Blank(),
                        approveProcess: locInfoRequest.currentApproveLevel,
                        requestTimeNum: locInfoRequest.requestTimeNum + 1
                    }
                );
                
                //Ký duyệt văn bản
                If(
                    locInfoRequest.currentApproveLevel = locInfoRequest.maxApproveLevel,
                    'ASDocument.DocumentSign'.Run(
                        2,
                        Now() & Char(10) & gblRecUser.fullName & Char(10) & gblRecUser.jobTitle,
                        locInfoRequest.documentID,
                        locInfoRequest.ID,
                        /*If(
                            locInfoRequest.lastSignNum = Last(
                                Filter(
                                    'ASDocument.ProcessApproval',
                                    documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.currentApproveLevel
                                )
                            ).sort,
                            First(
                                Filter(
                                    'ASDocument.ProcessApproval',
                                    documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.currentApproveLevel + 1
                                )
                            ).sort,
                            locInfoRequest.lastSignNum
                        )*/
                        locInfoRequest.lastSignNum,
                        locInfoRequest.pageSignNumber,
                        {
                            file: {
                                contentBytes: First(locInfoRequest.Attachments).Value,
                                name: "File van ban-" & Now() & ".pdf"
                            },
                            file_1: {
                                contentBytes: First(
                                    LookUp(
                                        'ASDocument.Users_Roles',
                                        userID = gblRecUser.userID And active = 1
                                    ).Attachments
                                ).Value,
                                name: "Signature-" & Now() & ".png"
                            }
                        }
                    ),
                    'ASDocument.DocumentSign'.Run(  
                        1,
                        Now() & Char(10) & gblRecUser.fullName & Char(10) & gblRecUser.jobTitle,
                        locInfoRequest.documentID,
                        locInfoRequest.ID,
                        /*If(
                            locInfoRequest.lastSignNum = Last(
                                Filter(
                                    'ASDocument.ProcessApproval',
                                    documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.currentApproveLevel
                                )
                            ).sort,
                            First(
                                Filter(
                                    'ASDocument.ProcessApproval',
                                    documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.currentApproveLevel + 1
                                )
                            ).sort,
                            locInfoRequest.lastSignNum
                        )*/
                        locInfoRequest.lastSignNum,
                        locInfoRequest.pageSignNumber,
                        {
                            file: {
                                contentBytes: First(locInfoRequest.Attachments).Value,
                                name: "File van ban-" & Now() & ".pdf"
                            },
                            file_1: {
                                contentBytes: First(
                                    LookUp(
                                        'ASDocument.Users_Roles',
                                        userID = gblRecUser.userID And active = 1
                                    ).Attachments
                                ).Value,
                                name: "Signature-" & Now() & ".png"
                            }
                        }
                    )
                );
                
                //Cập nhật trạng thái yêu cầu thành đã duyệt
                If(
                    locInfoRequest.approvalUserID = Last(
                        Filter(
                            'ASDocument.ProcessApproval',
                            documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.maxApproveLevel
                        )
                    ).userID,
                    Patch(
                        'ASDocument.DocumentRequest',
                        LookUp(
                            'ASDocument.DocumentRequest',
                            ID = locInfoRequest.ID
                        ),
                        {status: 2}
                    ),
                    Patch(
                        'ASDocument.DocumentRequest',
                        LookUp(
                            'ASDocument.DocumentRequest',
                            ID = locInfoRequest.ID
                        ),
                        {lastSignNum: If(locInfoRequest.lastSignNum = Last(
                                Filter(
                                    'ASDocument.ProcessApproval',
                                    documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.currentApproveLevel
                                )
                            ).sort,First(
                                Filter(
                                    'ASDocument.ProcessApproval',
                                    documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.currentApproveLevel + 1
                                )
                            ).sort,locInfoRequest.lastSignNum + 1)}
                    )
                );
                
                //Cập nhật bước duyệt hiện tại
                If(
                    locInfoRequest.lastSignNum = Last(
                        Filter(
                            'ASDocument.ProcessApproval',
                            documentID = locInfoRequest.documentID And approveProcess = locInfoRequest.currentApproveLevel
                        )
                    ).sort,
                    Patch(
                        'ASDocument.DocumentRequest',
                        LookUp(
                            'ASDocument.DocumentRequest',
                            ID = locInfoRequest.ID
                        ),
                        {currentApproveLevel: locInfoRequest.currentApproveLevel + 1}
                    )
                );
                
                //Cập nhật danh sách duyệt
                ClearCollect(
                    gblcolRequestOnProcess,
                    Filter(
                        'ASDocument.DocumentRequest' As Temp,
                        Temp.lastSignNum exactin (Filter(
                            'ASDocument.ProcessApproval',
                            documentID = Temp.documentID
                        )).sort And Temp.status = 1 And Temp.active = 1
                    )
                );
                ClearCollect(
                    gblColApprovalByRequest,
                    AddColumns(
                        gblcolRequestOnProcess As Temp,
                        "approvalUserID",
                        LookUp(
                            'ASDocument.ProcessApproval',
                            sort = Temp.lastSignNum And documentID = Temp.documentID
                        ).userID
                    )
                );
                
                //Lấy danh sách phê duyệt
                Refresh('ASDocument.DocumentRequest');Refresh('ASDocument.ProcessApproval');
                //Lấy danh sách phê duyệt
                ClearCollect(gblColApprovalByRequest,AddColumns(Filter('ASDocument.DocumentRequest',status = 1 And active = 1) As Temp,"approvalUserID",LookUp('ASDocument.ProcessApproval',sort = Temp.lastSignNum And approveProcess = Temp.currentApproveLevel And documentID = Temp.documentID).userID));
                
                Notify(
                    "Duyệt thành công",
                    NotificationType.Success,
                    1500
                );
                UpdateContext({locApprove: false})
            PressedColor: =RGBA(255,255,255,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Duyệt"
            Width: =87
            X: =879
            Y: =632
            ZIndex: =7

        btn_us_Cancel_8 As button:
            BorderThickness: =1
            Color: =RGBA(0, 0, 0, 1)
            Fill: =RGBA(255, 255, 255, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =UpdateContext({locApprove:false})
            PressedColor: =RGBA(0,0,0,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Hủy"
            Width: =87
            X: =779
            Y: =632
            ZIndex: =8

        HtmlText1_1 As htmlViewer:
            Height: =457
            HtmlText: |-
                ="<table  width='100%' border='1' cellpadding='5' style='border:1px solid black; border-collapse:collapse'>
                <tr>
                    <td style=width:200px><b>Mã tài liệu/hồ sơ</b></td>
                    <td>" & locInfoRequest.documentID &"</td>
                  </tr>
                  <tr>
                    <td style=width:200px><b>Tên văn bản</b></td>
                    <td>" & locInfoRequest.documentName &"</td>
                  </tr>
                  <tr>
                    <td style=width:100px><b>Công ty</b></td>
                    <td>" & LookUp('ASDocument.Company',ID = locInfoRequest.companyID).name &"</td>
                  </tr>
                  <tr>
                    <td style=width:100px><b>Đơn vị</b></td>
                    <td>" & LookUp('ASDocument.Division',ID = locInfoRequest.divisionID).name &"</td>
                  </tr>
                  <tr>
                    <td style=width:100px><b>Cấp</b></td>
                    <td>" & LookUp('ASDocument.DocumentLevel',levelID = locInfoRequest.levelID).name &"</td>
                  </tr>
                  <tr>
                    <td style=width:100px><b>Loại văn bản</b></td>
                    <td>" & LookUp('ASDocument.DocumentType',ID = locInfoRequest.documentTypeID).name &"</td>
                  </tr>
                  <tr>
                    <td style=width:100px><b>Người tạo</b></td>
                    <td>" & LookUp(gblColAllUser,userID = locInfoRequest.userID).fullName &"</td>
                  </tr>
                  <tr>
                    <td style=width:100px><b>Ngày tạo</b></td>
                    <td>" & locInfoRequest.Created &"</td>
                  </tr>
                  <tr>
                    <td style=width:100px><b>Trạng thái</b></td>
                    <td>" & If(locInfoRequest.status = 1,"Đang duyệt",locInfoRequest.status = 2,"Đã duyệt",locInfoRequest.status = 3,"Đã từ chối") &"</td>
                  </tr>
                </table>"
            Size: =13
            Width: =579
            X: =387
            Y: =159
            ZIndex: =9

    ctn_as_Transfer As groupContainer.manualLayoutContainer:
        Fill: =RGBA(0, 0, 0, 0.5)
        Height: =768
        RadiusBottomLeft: =20
        RadiusBottomRight: =20
        RadiusTopLeft: =20
        RadiusTopRight: =20
        Visible: =locTransfer
        Width: =1366
        ZIndex: =9

        btn_ds_BackGround_11 As button:
            BorderStyle: =BorderStyle.None
            DisabledFill: =RGBA(255, 255, 255, 1)
            DisplayMode: =DisplayMode.Disabled
            Height: =264
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: =""
            Width: =608
            X: =375
            Y: =253
            ZIndex: =1

        lbl_ds_Title_16 As label:
            FontWeight: =FontWeight.Bold
            Text: ="Ủy quyền phê duyệt"
            Width: =242
            X: =387
            Y: =263
            ZIndex: =2

        shp_ds_Deco_21 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =311
            ZIndex: =3

        ico_ds_Cancel_11 As icon.Cancel:
            Color: =RGBA(149, 149, 149, 1)
            Height: =29
            Icon: =Icon.Cancel
            OnSelect: |-
                =UpdateContext({locTransfer:false})
            Width: =25
            X: =942
            Y: =268
            ZIndex: =4

        lbl_ds_DepartmentName_13 As label:
            Align: =Align.Right
            FontWeight: =FontWeight.Semibold
            Text: ="Chi tiết"
            X: =387
            Y: =333
            ZIndex: =5

        shp_ds_Deco_22 As rectangle:
            Fill: =RGBA(202, 202, 202, 1)
            Height: =1
            Width: =608
            X: =375
            Y: =459
            ZIndex: =6

        btn_ds_Submit_7 As button:
            BorderThickness: =1
            Fill: =RGBA(0, 89, 204, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =Patch('ASDocument.ProcessApproval',LookUp('ASDocument.ProcessApproval',sort = locInfoRequest.lastSignNum And approveProcess = locInfoRequest.currentApproveLevel),{userID:cbo_as_User.Selected.userID});
                
                //Gửi mail
                'ASDocument.SendMail'.Run(cbo_as_User.Selected.email,"Yêu cầu ủy quyền ký duyệt cho văn bản " & locInfoRequest.documentName,"Tên yêu cầu: " & locInfoRequest.documentName & "<br>" & "Thời gian tạo yêu cầu: " & locInfoRequest.Created & "<br>" & "Người yêu cầu ủy quyền: " & LookUp(gblColAllUser,userID = locInfoRequest.approvalUserID).fullName);
                
                Notify("Ủy quyền thành công",NotificationType.Success,1500);
                UpdateContext({locTransfer:false})
            PressedColor: =RGBA(255,255,255,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Xác nhận"
            Width: =114
            X: =851
            Y: =470
            ZIndex: =7

        btn_ds_Cancel_11 As button:
            BorderThickness: =1
            Color: =RGBA(0, 0, 0, 1)
            Fill: =RGBA(255, 255, 255, 1)
            Height: =36
            HoverFill: =ColorFade(Self.Fill, -20%)
            OnSelect: |-
                =UpdateContext({locTransfer:false})
            PressedColor: =RGBA(0,0,0,1)
            PressedFill: =Self.Fill
            RadiusBottomLeft: =5
            RadiusBottomRight: =5
            RadiusTopLeft: =5
            RadiusTopRight: =5
            Text: ="Hủy"
            Width: =87
            X: =749
            Y: =470
            ZIndex: =8

        txt_ds_Name_5 As text:
            BorderColor: =RGBA(116, 116, 116, 1)
            BorderThickness: =1
            Default: =""
            HintText: ="Nhập nội dung"
            Width: =394
            X: =548
            Y: =333
            ZIndex: =14

        lbl_ds_DepartmentName_14 As label:
            Align: =Align.Right
            FontWeight: =FontWeight.Semibold
            Text: ="Ủy quyền"
            X: =387
            Y: =385
            ZIndex: =15

        cbo_as_User As combobox:
            BorderColor: =RGBA(116, 116, 116, 1)
            ChevronBackground: =RGBA(0, 89, 204, 1)
            DisplayFields: =["fullName","email"]
            InputTextPlaceholder: ="Chọn người ủy quyền"
            Items: =Filter(gblColAllUser,userID exactin (Filter('ASDocument.ProcessApproval',approveProcess = locInfoRequest.currentApproveLevel And documentID = locInfoRequest.documentID)).userID)
            NoSelectionText: ="Chọn người ủy quyền"
            SearchFields: =["email"]
            SearchItems: =Search(Filter(gblColAllUser,userID exactin (Filter('ASDocument.ProcessApproval',approveProcess = locInfoRequest.currentApproveLevel And documentID = locInfoRequest.documentID)).userID),cbo_as_User.SearchText,"email")
            SelectMultiple: =false
            Template: =ListItemTemplate.Person
            Width: =303
            X: =548
            Y: =385
            ZIndex: =17

    Form1 As form:
        DataSource: ='ASDocument.HistoryApprove'
        Height: =199
        Visible: =false
        Width: =141
        ZIndex: =10

        Attachments_DataCard1 As typedDataCard.attachmentsEditCard:
            BorderStyle: =BorderStyle.Solid
            DataField: ="{Attachments}"
            Default: =ThisItem.Attachments
            DisplayMode: =Parent.DisplayMode
            DisplayName: =DataSourceInfo([@'ASDocument.DocumentRequest'],DataSourceInfo.DisplayName,"{Attachments}")
            Fill: =RGBA(0, 0, 0, 0)
            Height: =171
            Required: =false
            Update: =DataCardValue1.Attachments
            Width: =47
            X: =0
            Y: =0
            ZIndex: =1

            DataCardKey1 As label:
                AutoHeight: =true
                Height: =34
                Text: =Parent.DisplayName
                Width: =Parent.Width - 60
                Wrap: =false
                X: =30
                Y: =10
                ZIndex: =1

            DataCardValue1 As attachments:
                BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                DisplayMode: =Parent.DisplayMode
                Height: =142
                IsInDataCard: =true
                Items: =Last(locInfoRequest.Attachments)
                PaddingBottom: =5
                PaddingLeft: =If(Self.DisplayMode = DisplayMode.Edit, 5, 0)
                PaddingRight: =5
                PaddingTop: =5
                Tooltip: =Parent.DisplayName
                Width: =91
                X: =30
                Y: =DataCardKey1.Y + DataCardKey1.Height + 5
                ZIndex: =2

            ErrorMessage1 As label:
                AutoHeight: =true
                Height: =10
                Live: =Live.Assertive
                PaddingBottom: =0
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Text: =Parent.Error
                Visible: =Parent.DisplayMode=DisplayMode.Edit
                Width: =Parent.Width - 60
                X: =30
                Y: =DataCardValue1.Y + DataCardValue1.Height
                ZIndex: =3

            StarVisible1 As label:
                Align: =Align.Center
                Height: =DataCardKey1.Height
                Text: ="*"
                Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                Width: =30
                Wrap: =false
                Y: =DataCardKey1.Y
                ZIndex: =4

